<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>リード管理システム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .section-border { border-left: 4px solid #3b82f6; }
        .required { color: #ef4444; }
        .form-section { background: #f8fafc; border: 1px solid #e2e8f0; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gray-900">リード管理システム</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="currentUserDisplay" class="text-gray-700">ゲストユーザー</span>
                    <a href="index.html" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                        ダッシュボードに戻る
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-blue-600">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex space-x-8">
                <button class="text-white px-4 py-3 bg-blue-700">
                    <i class="fas fa-users mr-2"></i>リード管理
                </button>
                <a href="index.html" class="text-white px-4 py-3 hover:bg-blue-700 flex items-center">
                    <i class="fas fa-chart-bar mr-2"></i>ダッシュボード
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Lead List Section -->
        <div id="leadListSection" class="mb-8">
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-semibold text-gray-900">リード一覧</h2>
                        <button onclick="showAddForm()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                            <i class="fas fa-plus mr-2"></i>新規リード追加
                        </button>
                    </div>
                </div>

                <!-- Search and Filter -->
                <div class="px-6 py-4 bg-gray-50 border-b">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <input type="text" id="searchCompany" placeholder="会社名で検索" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <select id="filterStatus" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">全ステータス</option>
                                <option value="新規">新規</option>
                                <option value="アプローチ中">アプローチ中</option>
                                <option value="商談中">商談中</option>
                                <option value="提案済">提案済</option>
                                <option value="受注">受注</option>
                                <option value="失注">失注</option>
                                <option value="保留">保留</option>
                            </select>
                        </div>
                        <div>
                            <select id="filterTeam" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">全チーム</option>
                                <option value="Aチーム">Aチーム</option>
                                <option value="Bチーム">Bチーム</option>
                                <option value="Cチーム">Cチーム</option>
                                <option value="管理部">管理部</option>
                            </select>
                        </div>
                        <div>
                            <button onclick="searchLeads()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                                <i class="fas fa-search mr-2"></i>検索
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Lead Table -->
                <div class="overflow-x-auto">
                    <div id="leadTableContainer">読み込み中...</div>
                </div>
            </div>
        </div>

        <!-- Lead Form Section -->
        <div id="leadFormSection" class="hidden">
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h2 id="formTitle" class="text-xl font-semibold text-gray-900">新規リード追加</h2>
                        <button onclick="showLeadList()" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700">
                            <i class="fas fa-list mr-2"></i>一覧に戻る
                        </button>
                    </div>
                </div>

                <form id="leadForm" class="p-6 space-y-8">
                    <!-- 登録情報セクション -->
                    <div class="form-section p-6 rounded-lg">
                        <h3 class="section-border pl-4 text-lg font-semibold text-gray-900 mb-6">登録情報</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    リードNo. <span class="required">*</span>
                                </label>
                                <input type="text" name="lead_no" id="lead_no" readonly
                                       class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md">
                                <p class="text-xs text-gray-500 mt-1">自動付与されます</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    登録日 <span class="required">*</span>
                                </label>
                                <input type="date" name="registration_date" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    ステータス <span class="required">*</span>
                                </label>
                                <select name="status" required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">選択してください</option>
                                    <option value="新規">新規</option>
                                    <option value="アプローチ中">アプローチ中</option>
                                    <option value="商談中">商談中</option>
                                    <option value="提案済">提案済</option>
                                    <option value="受注">受注</option>
                                    <option value="失注">失注</option>
                                    <option value="保留">保留</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    担当チーム <span class="required">*</span>
                                </label>
                                <select name="assigned_team" required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">選択してください</option>
                                    <option value="Aチーム">Aチーム</option>
                                    <option value="Bチーム">Bチーム</option>
                                    <option value="Cチーム">Cチーム</option>
                                    <option value="管理部">管理部</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    リード獲得者 <span class="required">*</span>
                                </label>
                                <select name="lead_source" required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">選択してください</option>
                                    <option value="田中太郎">田中太郎</option>
                                    <option value="佐藤花子">佐藤花子</option>
                                    <option value="山田次郎">山田次郎</option>
                                    <option value="管理者">管理者</option>
                                    <option value="その他">その他</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    営業担当
                                </label>
                                <select name="sales_rep"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">選択してください</option>
                                    <option value="田中太郎">田中太郎</option>
                                    <option value="佐藤花子">佐藤花子</option>
                                    <option value="山田次郎">山田次郎</option>
                                    <option value="管理者">管理者</option>
                                    <option value="未割当">未割当</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 会社情報セクション -->
                    <div class="form-section p-6 rounded-lg">
                        <h3 class="section-border pl-4 text-lg font-semibold text-gray-900 mb-6">会社情報</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    新規／既存 <span class="required">*</span>
                                </label>
                                <select name="customer_type" required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">選択してください</option>
                                    <option value="新規">新規</option>
                                    <option value="既存">既存</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    会社名 <span class="required">*</span>
                                </label>
                                <input type="text" name="company_name" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">部署／役職</label>
                                <input type="text" name="department_title"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    担当者名 <span class="required">*</span>
                                </label>
                                <input type="text" name="contact_name" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">メールアドレス</label>
                                <input type="email" name="email"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">電話番号</label>
                                <input type="tel" name="phone" pattern="[0-9\-]+"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">郵便番号</label>
                                <input type="text" name="postal_code" pattern="[0-9]{7}" maxlength="7"
                                       placeholder="1234567"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">都道府県</label>
                                <input type="text" name="prefecture"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">市区町村</label>
                                <input type="text" name="city"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">住所</label>
                                <input type="text" name="address"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">ウェブサイト</label>
                                <input type="url" name="website" placeholder="https://example.com"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>

                    <!-- その他セクション -->
                    <div class="form-section p-6 rounded-lg">
                        <h3 class="section-border pl-4 text-lg font-semibold text-gray-900 mb-6">その他</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">見込金額</label>
                                <input type="number" name="estimated_amount" min="0" step="1000"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div id="lostReasonSection" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">失注理由</label>
                                <select name="lost_reason"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">選択してください</option>
                                    <option value="予算不足">予算不足</option>
                                    <option value="競合他社選定">競合他社選定</option>
                                    <option value="案件取りやめ">案件取りやめ</option>
                                    <option value="決定権者不在">決定権者不在</option>
                                    <option value="タイミング不適切">タイミング不適切</option>
                                    <option value="要件不一致">要件不一致</option>
                                    <option value="その他">その他</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">備考</label>
                                <textarea name="notes" rows="4"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Buttons -->
                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="showLeadList()" 
                                class="px-6 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                            キャンセル
                        </button>
                        <button type="submit" 
                                class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            <i class="fas fa-save mr-2"></i>保存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- Messages -->
    <div id="messages" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script>
        // Global variables
        let allLeads = [];
        let currentEditId = null;
        let nextLeadNo = 1;

        // Initialize
        window.onload = function() {
            // Try to get user info from main dashboard if available
            try {
                const mainWindow = window.opener;
                if (mainWindow && mainWindow.currentUser) {
                    document.getElementById('currentUserDisplay').textContent = 
                        `${mainWindow.currentUser.name} (${mainWindow.currentUser.team})`;
                }
            } catch (e) {
                // If not available, use default
                document.getElementById('currentUserDisplay').textContent = 'リード管理ユーザー';
            }
            
            loadLeads();
            setupEventListeners();
            setDefaultDate();
        };

        function setupEventListeners() {
            // Status change listener for lost reason
            document.querySelector('select[name="status"]').addEventListener('change', function() {
                const lostReasonSection = document.getElementById('lostReasonSection');
                if (this.value === '失注') {
                    lostReasonSection.classList.remove('hidden');
                } else {
                    lostReasonSection.classList.add('hidden');
                }
            });

            // Form submission
            document.getElementById('leadForm').addEventListener('submit', handleFormSubmit);

            // Search functionality
            document.getElementById('searchCompany').addEventListener('input', searchLeads);
            document.getElementById('filterStatus').addEventListener('change', searchLeads);
            document.getElementById('filterTeam').addEventListener('change', searchLeads);
        }

        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="registration_date"]').value = today;
        }

        // Load leads data
        async function loadLeads() {
            try {
                const response = await fetch('tables/leads_new');
                if (response.ok) {
                    const data = await response.json();
                    allLeads = data.data || [];
                    updateNextLeadNo();
                    renderLeadsTable(allLeads);
                } else {
                    showMessage('リードの読み込みに失敗しました', 'error');
                    document.getElementById('leadTableContainer').innerHTML = '<p class="p-6 text-gray-500">データを読み込めませんでした</p>';
                }
            } catch (error) {
                console.error('Load leads error:', error);
                showMessage('リードの読み込み中にエラーが発生しました', 'error');
                document.getElementById('leadTableContainer').innerHTML = '<p class="p-6 text-red-500">エラーが発生しました</p>';
            }
        }

        function updateNextLeadNo() {
            if (allLeads.length > 0) {
                const maxNo = Math.max(...allLeads.map(lead => parseInt(lead.lead_no) || 0));
                nextLeadNo = maxNo + 1;
            }
            document.getElementById('lead_no').value = String(nextLeadNo).padStart(5, '0');
        }

        // Render leads table
        function renderLeadsTable(leads) {
            if (!leads.length) {
                document.getElementById('leadTableContainer').innerHTML = '<p class="p-6 text-gray-500">リードがありません</p>';
                return;
            }

            const table = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">リードNo.</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">会社名</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">担当者</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ステータス</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">チーム</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">営業担当</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">見込金額</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">登録日</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${leads.map(lead => `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${lead.lead_no || ''}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${lead.company_name || ''}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${lead.contact_name || ''}</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusBadgeClass(lead.status)}">
                                        ${lead.status || ''}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${lead.assigned_team || ''}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${lead.sales_rep || '未割当'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">¥${(lead.estimated_amount || 0).toLocaleString()}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(lead.registration_date)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button onclick="editLead('${lead.id}')" class="text-blue-600 hover:text-blue-900 mr-3">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteLead('${lead.id}')" class="text-red-600 hover:text-red-900">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('leadTableContainer').innerHTML = table;
        }

        // Status badge styling
        function getStatusBadgeClass(status) {
            const statusMap = {
                '新規': 'bg-blue-100 text-blue-800',
                'アプローチ中': 'bg-yellow-100 text-yellow-800',
                '商談中': 'bg-orange-100 text-orange-800',
                '提案済': 'bg-purple-100 text-purple-800',
                '受注': 'bg-green-100 text-green-800',
                '失注': 'bg-red-100 text-red-800',
                '保留': 'bg-gray-100 text-gray-800'
            };
            return statusMap[status] || 'bg-gray-100 text-gray-800';
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('ja-JP');
        }

        // Search and filter
        function searchLeads() {
            const searchCompany = document.getElementById('searchCompany').value.toLowerCase();
            const filterStatus = document.getElementById('filterStatus').value;
            const filterTeam = document.getElementById('filterTeam').value;

            const filtered = allLeads.filter(lead => {
                const matchCompany = !searchCompany || (lead.company_name || '').toLowerCase().includes(searchCompany);
                const matchStatus = !filterStatus || lead.status === filterStatus;
                const matchTeam = !filterTeam || lead.assigned_team === filterTeam;
                return matchCompany && matchStatus && matchTeam;
            });

            renderLeadsTable(filtered);
        }

        // Show add form
        function showAddForm() {
            currentEditId = null;
            document.getElementById('formTitle').textContent = '新規リード追加';
            document.getElementById('leadListSection').classList.add('hidden');
            document.getElementById('leadFormSection').classList.remove('hidden');
            document.getElementById('leadForm').reset();
            setDefaultDate();
            updateNextLeadNo();
        }

        // Show lead list
        function showLeadList() {
            document.getElementById('leadListSection').classList.remove('hidden');
            document.getElementById('leadFormSection').classList.add('hidden');
        }

        // Edit lead
        async function editLead(leadId) {
            try {
                const response = await fetch(`tables/leads_new/${leadId}`);
                if (response.ok) {
                    const lead = await response.json();
                    currentEditId = leadId;
                    document.getElementById('formTitle').textContent = 'リード編集';
                    
                    // Populate form
                    Object.keys(lead).forEach(key => {
                        const field = document.querySelector(`[name="${key}"]`);
                        if (field) {
                            if (key === 'registration_date' && lead[key]) {
                                try {
                                    const date = new Date(lead[key]);
                                    field.value = date.toISOString().split('T')[0];
                                } catch (dateError) {
                                    console.error('Date parsing error:', dateError);
                                    field.value = new Date().toISOString().split('T')[0];
                                }
                            } else {
                                field.value = lead[key] || '';
                            }
                        }
                    });
                    
                    // Show lost reason section if status is 失注
                    if (lead.status === '失注') {
                        document.getElementById('lostReasonSection').classList.remove('hidden');
                    }
                    
                    showAddForm();
                } else {
                    showMessage('リードの読み込みに失敗しました', 'error');
                }
            } catch (error) {
                console.error('Edit lead error:', error);
                showMessage('エラーが発生しました', 'error');
            }
        }

        // Delete lead
        async function deleteLead(leadId) {
            if (!confirm('このリードを削除してもよろしいですか？')) return;
            
            try {
                const response = await fetch(`tables/leads_new/${leadId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showMessage('リードを削除しました', 'success');
                    loadLeads();
                } else {
                    showMessage('削除に失敗しました', 'error');
                }
            } catch (error) {
                console.error('Delete lead error:', error);
                showMessage('エラーが発生しました', 'error');
            }
        }

        // Handle form submission
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            // Check required fields
            const requiredFields = ['registration_date', 'status', 'assigned_team', 'lead_source', 'customer_type', 'company_name', 'contact_name'];
            const missingFields = [];
            
            requiredFields.forEach(field => {
                const element = document.querySelector(`[name="${field}"]`);
                if (!element || !element.value.trim()) {
                    missingFields.push(field);
                }
            });
            
            if (missingFields.length > 0) {
                showMessage(`必須項目が入力されていません: ${missingFields.join(', ')}`, 'error');
                return;
            }
            
            const formData = new FormData(e.target);
            const leadData = Object.fromEntries(formData.entries());
            
            // Remove empty fields and system fields
            Object.keys(leadData).forEach(key => {
                if (leadData[key] === '' || leadData[key] === null) {
                    delete leadData[key];
                }
            });
            
            // Remove system-generated fields for both new and edit operations
            delete leadData.id;
            delete leadData.created_at;
            delete leadData.updated_at;
            delete leadData.gs_project_id;
            delete leadData.gs_table_name;
            
            // Convert registration_date to ISO format
            if (leadData.registration_date) {
                try {
                    const date = new Date(leadData.registration_date + 'T09:00:00.000Z');
                    leadData.registration_date = date.toISOString();
                } catch (dateError) {
                    console.error('Date conversion error:', dateError);
                    leadData.registration_date = new Date().toISOString();
                }
            }
            
            // Convert estimated_amount to number if present
            if (leadData.estimated_amount) {
                leadData.estimated_amount = parseInt(leadData.estimated_amount);
            }
            
            // Auto-generate lead_no for new leads
            if (!currentEditId) {
                leadData.lead_no = String(nextLeadNo).padStart(5, '0');
            }
            
            console.log('Sending lead data:', leadData);
            console.log('Current edit ID:', currentEditId);
            
            // Disable submit button to prevent double submission
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>保存中...';
            
            try {
                let response;
                if (currentEditId) {
                    response = await fetch(`tables/leads_new/${currentEditId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(leadData)
                    });
                } else {
                    response = await fetch('tables/leads_new', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(leadData)
                    });
                }
                
                if (response.ok) {
                    showMessage(currentEditId ? 'リードを更新しました' : 'リードを追加しました', 'success');
                    showLeadList();
                    loadLeads();
                } else {
                    const errorText = await response.text();
                    console.error('Save error details:', {
                        status: response.status,
                        statusText: response.statusText,
                        body: errorText
                    });
                    let errorMessage = '保存に失敗しました';
                    try {
                        const errorData = JSON.parse(errorText);
                        if (errorData.message) {
                            errorMessage += `: ${errorData.message}`;
                        }
                        if (errorData.errors && errorData.errors.length > 0) {
                            const errorDetails = errorData.errors.map(err => `${err.loc.join('.')}: ${err.msg}`).join(', ');
                            errorMessage += ` (${errorDetails})`;
                        }
                    } catch (parseError) {
                        errorMessage += `: ${errorText}`;
                    }
                    showMessage(errorMessage, 'error');
                }
            } catch (error) {
                console.error('Save lead error:', error);
                showMessage('保存中にエラーが発生しました', 'error');
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }

        // Message system
        function showMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-100 text-green-800 border-green-300' : 
                           type === 'error' ? 'bg-red-100 text-red-800 border-red-300' : 
                           'bg-blue-100 text-blue-800 border-blue-300';
            
            messageDiv.className = `${bgColor} px-4 py-2 rounded-md shadow-md transition-opacity duration-300 border`;
            messageDiv.textContent = message;
            
            document.getElementById('messages').appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.style.opacity = '0';
                setTimeout(() => messageDiv.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>